(Tumblr.Post||Tumblr.PostView||Tumblr.Posts||Tumblr.PostsView)||(function(g,q){var p=q.Features;var j=p("is_logged_in");var k=Backbone.View.extend({el:"#posts",initialize:function(){this.collection=q.Posts;this.postViews=[];this.form_key=g("#tumblr_form_key").attr("content");this.createPosts();q.AutoPaginator.on("after",this.createPosts.bind(this));q.Events.on("posts:load",this.createPosts.bind(this));q.Events.on("post:like",this.likePostById.bind(this));q.Events.on("post:fastreblog",this.fastReblogById.bind(this))},createPosts:function(){var r=_.map(this.$el.find(".post:not(.new_post_buttons):not([data-view-exists])"),this.createPost.bind(this));q.Events.trigger("PostsView:addBatch",r)},createPost:function(v,u){var r=g(v);var x;try{x=JSON.parse(r.find(".reblog_source [data-tumblelog-popover]").attr("data-tumblelog-popover"))}catch(w){x={}}var t=new d({id:r.attr("data-post-id"),type:r.attr("data-type"),root_id:r.attr("data-root-id"),tumblelog:r.attr("data-tumblelog-name"),tumblelog_key:r.attr("data-tumblelog-key"),reblog_key:r.attr("data-reblog-key"),is_mine:r.hasClass("is_mine"),accepts_answers:(r.attr("data-accepts-answers")==="1"),following_tumblelog:(r.attr("data-following-tumblelog")==="1"),reblogged:false,liked:r.find(".post_control.like").hasClass("liked"),form_key:this.form_key,sponsored:(r.attr("data-sponsored")==="1"),placement_id:r.attr("data-placement-id")||false,featured_tags:(r.attr("data-featured-tags")||"").split(","),reblog_source:x});var s=j(function(){var y=(t.get("type")==="fan_mail")?l:c;return new y({el:r,model:t})},function(){return new f({el:r,model:t})});this.collection.add(t);this.postViews.push(s);r.attr("data-view-exists",true);q.Events.trigger("PostsView:add",s);return s},likePostById:function(s,r){r=r||"mouse";this.collection.get(s).like(r)},fastReblogById:function(s,r){this.collection.get(s).fastReblog(r)}});var m=Backbone.Collection.extend({model:d,initialize:function(){this.on("change:liked",this.updateLikeStatus.bind(this));this.on("ignore:success",this.dismiss.bind(this));this.on("unfollow:success",this.dismiss.bind(this))},updateLikeStatus:function(r,s){var t=this.whereBy({liked:!s,root_id:r.get("root_id")});t.invoke("set",{liked:s});if(r.get("liked")){t.invoke("trigger","like:success")}else{t.invoke("trigger","unlike:success")}},dismiss:function(r){this.whereBy({tumblelog:r.get("tumblelog"),sponsored:false}).invoke("dismiss")},whereBy:function(r){return new m(this.where(r))}});var d=Backbone.Model.extend({initialize:function(r,s){this.tumblelog=new q.Models.Tumblelog({name:r.tumblelog,following:r.following_tumblelog,ignoring:false,sponsor:r.sponsored});if(r.reblog_source&&r.reblog_source.name){this.reblog_tumblelog=new q.Models.Tumblelog({name:r.reblog_source.name,following:r.reblog_source.is_following,ignoring:false})}},getLikeSource:function(r){r=r||"like";var s="LIKE_";switch(r){case"unlike":s="UNLIKE_";break;case"reply":s="REPLY_";break;case"ignore":s="IGNORE_"}var t=location.pathname;if(t.match(/^\/dashboard/)){return s+"SOURCE_DASHBOARD"}if(t.match(/^\/tagged/)){return s+"SOURCE_TAG_PAGE"}if(t.match(/^\/likes/)){return s+"SOURCE_LIKES_PAGE"}if(t.match(/^\/inbox/)){return s+"SOURCE_INBOX"}if(t.match(/^\/search/)){return s+"SOURCE_SEARCH_RESULTS_PAGE"}return s+"SOURCE_UNKNOWN"},likePayload:function(s,r){s=s||"mouse";r=r||"LIKE_SOURCE_UNKNOWN";return{id:this.get("id"),key:this.get("reblog_key"),method:s,source:r,placement_id:this.get("placement_id")||false}},like:function(r){if(this.get("is_mine")){return}this.trigger("like:success",this);if(!this.get("liked")){this.set("liked",true);q.like(this.likePayload(r,this.getLikeSource("like"))).error(this.trigger.bind(this,"like:failure"))}},xhr_request:function(r,u,s){u=_.extend(u,{form_key:this.get("form_key")});var t=g.ajax({data:JSON.stringify(u),type:"POST",url:r});t.done(_.bind(function(v){if(s[200]){s[200].call(this,v)}},this));t.fail(_.bind(function(x,v,w){if(s[x.status]){s[x.status].call(this,x.status)}},this))},unlike:function(){this.set("liked",false);this.trigger("unlike:success",this);q.unlike(this.likePayload("mouse",this.getLikeSource("unlike"))).error(this.trigger.bind(this,"unlike:failure"))},toggleLike:function(){if(this.get("liked")){this.unlike()}else{this.like()}},reblog:function(){if(this.get("reblogged")){return}this.set("reblogged",true);return g.ajax({url:"/fast_reblog",type:"post",data:{reblog_key:this.get("reblog_key"),reblog_post_id:this.get("id"),form_key:g("#tumblr_form_key").attr("content")},success:function(){this.set("reblogged",true)}.bind(this),error:function(){this.set("reblogged",false)}.bind(this)})},fastReblog:function(r){r=r||false;this.trigger("fastreblog:success",r);this.set("reblogged",true);return g.ajax({url:"/fast_reblog",type:"post",data:{reblog_key:this.get("reblog_key"),reblog_post_id:this.get("id"),form_key:g("#tumblr_form_key").attr("content"),queue:r},success:function(){this.set("reblogged",true)}.bind(this),error:function(){this.set("reblogged",false)}.bind(this)})},reply:function(s){var r=q.reply({reply_text:s,post_id:this.get("id"),tumblelog:this.get("tumblelog"),tumblelog_key:this.get("tumblelog_key"),source:this.getLikeSource("reply")});r.done(function(){this.trigger("replied")}.bind(this));return r},destroy:function(){var r={post_id:this.get("id"),channel_id:this.get("tumblelog")};this.xhr_request("/svc/post/delete",r,{200:this.trigger.bind(this,"destroy:success"),401:this.trigger.bind(this,"destroy:failure"),403:this.trigger.bind(this,"destroy:failure"),500:this.trigger.bind(this,"destroy:failure"),})},toggle_spam_tumblelog:function(){var r=g.ajax({url:"/spam/toggle",type:"post",data:{tumblelog:this.get("tumblelog"),form_key:this.get("form_key")}});r.fail(this.trigger.bind(this,"spam_toggle:failure"));r.done(this.trigger.bind(this,"spam_toggle:success"));return r},toggle_nsfw_tumblelog:function(){var r=g.ajax({url:"/nsfw/toggle",type:"post",data:{tumblelog:this.get("tumblelog"),form_key:this.get("form_key")}});r.fail(this.trigger.bind(this,"nsfw_toggle:failure"));r.done(this.trigger.bind(this,"nsfw_toggle:success"));return r},toggle_adult_tumblelog:function(){var r=g.ajax({url:"/adult/toggle",type:"post",data:{tumblelog:this.get("tumblelog"),form_key:this.get("form_key")}});r.fail(this.trigger.bind(this,"adult_toggle:failure"));r.done(this.trigger.bind(this,"adult_toggle:success"));return r},toggle_follow:function(t){var r;var s={tumblelog:this.get("tumblelog"),source:t};if(this.get("following_tumblelog")){this.set("following_tumblelog",false);r=q.unfollow(s);r.done(this.trigger.bind(this,"unfollow:success",this));r.fail(this.trigger.bind(this,"unfollow:failure",this))}else{this.set("following_tumblelog",true);r=q.follow(s);r.done(this.trigger.bind(this,"follow:success",this));r.fail(this.trigger.bind(this,"follow:failure",this))}return r},fan_mail:function(){if(_.isObject(q.FanMail)){var r={href:q.FanMail.make_url_from_tumblelog(this.get("tumblelog"))};q.FanMail.show(r)}},publish:function(){var r=g.ajax({url:"/publish",type:"post",data:{form_key:this.get("form_key"),id:this.get("id")}});r.fail(this.trigger.bind(this,"publish:failure"));r.done(this.trigger.bind(this,"publish:success"))},promote:function(r){var s=g.ajax({url:"/svc/promote",type:"post",data:{tag:r,post_id:this.get("id"),form_key:this.get("form_key"),reblog_key:this.get("reblog_key"),tumblelog_name:this.get("tumblelog")}});s.fail(this.trigger.bind(this,"promote:failure"));s.done(function(t){if(t&&t.status&&t.status=="failure"){this.trigger("promote:failure",t.error)}else{this.trigger("promote:success",r)}}.bind(this));return s},unpromote:function(r){var s=g.ajax({url:"/svc/unpromote",type:"post",data:{tag_id:r,post_id:this.get("id"),form_key:this.get("form_key"),reblog_key:this.get("reblog_key"),tumblelog_name:this.get("tumblelog")}});s.fail(this.trigger.bind(this,"unpromote:failure"));s.done(this.trigger.bind(this,"unpromote:success"));return s},follow:function(s,r){s=s||this.get("tumblelog");q.follow({tumblelog:s,source:r,placement_id:this.get("placement_id")||false},{success:g.proxy(function(){q.Events.trigger("follow_tumblelog",{tumblelog:s});this.trigger("follow:success",this)},this),error:g.proxy(function(){this.trigger("follow:failure",this)},this)})},ignore:function(u){u=u||this.get("tumblelog");var t=q.ignore({tumblelog:u,source:this.getLikeSource("ignore")});var s=u.match(/post\_id\:/);var r=!s;t.done(function(){q.Events.trigger("block_tumblelog",{tumblelog:u,can_report:r});if(u==this.get("tumblelog")){this.trigger("ignore:success",this)}else{this.dismiss()}}.bind(this));t.fail(this.trigger.bind(this,"ignore:failure"))},queue:function(){var r=g.ajax({url:"/publish",type:"post",data:{form_key:this.get("form_key"),id:this.get("id"),queue:"queue"}});r.fail(this.trigger.bind(this,"queue:failure"));r.done(this.trigger.bind(this,"queue:success"))},removeSource:function(){var r=g.ajax({url:"/remove_app_attribution",type:"post",dataType:"text",data:{post_id:this.get("id"),tumblelog_id:this.get("tumblelog"),form_key:this.get("form_key")}});r.done(this.trigger.bind(this,"remove_source:success"));r.fail(this.trigger.bind(this,"remove_source:failure"));return r},dismiss:function(){this.trigger("dismiss",this)},approve:function(r){var t={form_key:this.get("form_key"),id:this.get("id")};if(r){t.queue=true}var s=g.ajax({url:"/approve_submission/"+this.get("id"),type:"post",dataType:"text",data:t});s.fail(this.trigger.bind(this,"approve:failure"));s.done(this.trigger.bind(this,"approve:success"));return s},deny:function(){var r=g.ajax({url:"/deny_submission",type:"post",dataType:"text",data:{pid:this.get("id"),form_key:this.get("form_key")}});r.fail(this.trigger.bind(this,"deny:failure"));r.done(this.trigger.bind(this,"deny:success"));return r},answer:function(s){var r=g.ajax({url:"/answer",type:"post",data:{form_key:this.get("form_key"),post_id:this.get("id"),tumblelog:this.get("tumblelog"),key:this.get("tumblelog_key"),answer_text:s}});r.fail(this.trigger.bind(this,"answer:failure"));r.done(this.trigger.bind(this,"answer:success"));return r}});var i=q.PopoverWithForm.extend({template:"#post_reply_form",events:{"input textarea":"check_form_state","keydown textarea":"on_keydown"},initialize:function(r){this.options=r||{};var s=_.template(g(this.template).html());this.$el.html(s());this.submit_button=this.$("button");this.textarea=this.$("form textarea");this.check_form_state();this.is_empty=true;_.extend(this.options,{on_hide:this.on_hide,on_show:this.on_show});q.PopoverWithForm.prototype.initialize.apply(this,arguments)},on_keydown:function(r){this.check_form_state();if(!this.is_empty&&(r.ctrlKey||r.metaKey)&&r.which===13){r.preventDefault();this.submit_form()}},check_form_state:function(){this.is_empty=!!(this.textarea[0].value.length===0);this.submit_button.attr("disabled",this.is_empty)},on_show:function(){this.position()},on_hide:function(){this.$el.removeClass("active")},submit_form:function(s){if(s){s.preventDefault()}this.submit_button.attr("disabled",true);this.submit_button.html(this.submit_button.data("label-loading"));var r=this.model.reply(this.textarea.val());r.done(this.on_success.bind(this))},on_success:function(){this.model.set("replied_to",true);this.trigger("success");this.$el.find("button").attr("disabled",false);this.$el.find("textarea").val("");this.hide();this.submit_button.html(this.submit_button.data("label"))}});var e=q.Popover.extend({events:{"click .post_control.delete":"delete","click .post_control.edit":"edit","click .post_control.queue":"queue"},initialize:function(r){this.options=r||{};_.extend(this.options,{on_show:this.on_show,disable_auto_show:true});q.Popover.prototype.initialize.apply(this,arguments)},"delete":function(r){this.hide();this.$el.removeClass("active")},edit:function(r){this.hide();this.$el.removeClass("active");this.trigger("action:edit");if(q.PostForms){r.preventDefault()}},queue:function(r){this.hide()},on_show:function(){this.position()}});var a=Backbone.View.extend({events:{"click .promote_post a":"promote","change select.promotable_tags":"promote_select"},button_count:5,initialize:function(r){this.model.on("promote:success",this.update_tag_count.bind(this));this.render()},render:function(){this.$el.html(this.template())},promote:function(t){var r=g(t.currentTarget);var s=this.model.promote(r.data("tag"));r.addClass("loading");s.always(r.removeClass.bind(r,"loading"));if(q.Popover){q.Popover.hide_all()}},update_tag_count:function(r){for(var s=0;s<window.promotable_tags.length;s++){if(window.promotable_tags[s].tag==r){window.promotable_tags[s].promote_diff-=1}}this.render()},promote_select:function(t){var r=g(t.currentTarget);var s=this.model.promote(r.val());if(q.Popover){q.Popover.hide_all()}},show:function(r){this.$el.show();this.$el.removeClass("hidden")},hide:function(r){this.$el.hide();this.$el.addClass("hidden")},template:function(){var r=_.compact(this.$el.data("promotion-warnings").split(";;"));var s="";s+="<ul>";s+='<li class="popover_sub_header promote_post_header">Promote</li>';if(window.promotable_tags.length>this.button_count){s+='<div class="promote_select_wrapper">';s+='<select class="popover_menu_item promotable_tags">';s+='<option value="">'+l10n_str.promote_this_post_in+"</option>"}_.each(window.promotable_tags,function(t,v){var u=(t.promote_diff<0)?"":" ("+t.promote_diff+")";if(t.promote_diff===0){r.push(l10n_str.promote_warning_none.replace("%1$s",t.title))}if(window.promotable_tags.length>this.button_count){s+='<option value="'+t.tag+'">'+window.promotable_tags[v].title+u+"</option>"}else{s+='<li class="popover_menu_item promote_post">';s+='<a data-tag="'+t.tag+'" href="#">';s+=window.promotable_tags[v].title+u;s+="</a>";s+="</li>"}},this);if(window.promotable_tags.length>this.button_count){s+="</select>";s+="</div>"}if(r.length){s+='<div class="promote_pane_warnings>';_.each(r,function(t){s+='<div class="warning">'+t+"</div>"});s+="</div>"}s+="</ul>";return s}});var b=q.Popover.extend({events:{"click .post_control.unpromote":"unpromote","click .post_control.remove_source":"remove_source"},initialize:function(r){this.options=r||{};_.extend(this.options,{on_show:this.on_show,on_hide:this.on_hide,disable_auto_show:true});if(window.promotable_tags&&window.promotable_tags.length){this.promote_tag_view=new a({el:this.$(".promote_pane"),model:this.model,tags:window.promotable_tags});this.promote_tag_view.show()}this.model.on("remove_source:failure",this.error.bind(this));q.Popover.prototype.initialize.apply(this,arguments)},on_show:function(){this.position()},remove_source:function(){this.hide();this.model.removeSource()},on_hide:function(){},error:function(){q.Dialog.alert("Error removing source from this post")},promote:function(r){r.preventDefault();if(!(this.promote_tag_view instanceof a)){this.promote_tag_view=new a({el:this.$(".promote_pane"),model:this.model,tags:window.promotable_tags})}this.promote_tag_view.show()},unpromote:function(t){var r=g(t.currentTarget);var s=this.model.unpromote(r.data("tag"));r.addClass("loading");s.always(r.removeClass.bind(r,"loading"))},});var h=q.Popover.extend({initialize:function(r){this.options=r||{};_.extend(this.options,{on_show:this.on_show,on_hide:this.on_hide,disable_auto_show:false});this.model.on("nsfw_toggle:success",this.toggle_nsfw_class.bind(this));this.model.on("adult_toggle:success",this.toggle_adult_class.bind(this));this.model.on("spam_toggle:success",this.toggle_spam_class.bind(this));this.model.on("unfollow:success",this.toggle_follow_class.bind(this));this.model.on("follow:success",this.toggle_follow_class.bind(this));this.$el.on("click",".user_menu_toggle_spam",this.toggle_spam.bind(this));this.$el.on("click",".user_menu_toggle_nsfw",this.toggle_nsfw.bind(this));this.$el.on("click",".user_menu_toggle_adult",this.toggle_adult.bind(this));this.$el.on("click",".user_menu_toggle_follow",this.toggle_follow.bind(this));this.$el.on("click",".fan_mail",this.fan_mail.bind(this));q.Popover.prototype.initialize.apply(this,arguments)},on_show:function(){this.position();this.$el.addClass("active")},on_hide:function(){this.$el.removeClass("active")},fan_mail:function(r){if(_.isObject(q.FanMail)){r.preventDefault();this.hide();this.model.fan_mail()}},toggle_spam:function(r){r.preventDefault();this.hide();this.model.toggle_spam_tumblelog()},toggle_nsfw:function(r){r.preventDefault();this.hide();this.model.toggle_nsfw_tumblelog()},toggle_adult:function(r){r.preventDefault();this.hide();this.model.toggle_adult_tumblelog()},toggle_follow:function(r){r.preventDefault();this.hide();this.model.toggle_follow("FOLLOW_SOURCE_DASHBOARD")},toggle_spam_class:function(){this.$(".user_menu_toggle_spam").toggleClass("is_spam")},toggle_nsfw_class:function(){this.$(".user_menu_toggle_nsfw").toggleClass("is_nsfw")},toggle_adult_class:function(){this.$(".user_menu_toggle_adult").toggleClass("is_adult")},toggle_follow_class:function(){this.$(".user_menu_toggle_follow").toggleClass("follow").toggleClass("unfollow")}});var c=Backbone.View.extend({events:{"click .post_control.like:not(.liked)":"like","click .post_control.liked":"unlike","click .post_control.reblog":"reblog","click .post_control.reply":"reply","click .post_control.block":"ignore","click .post_control.publish":"publish","click .post_control.queue":"queue","click .post_control.queue_submission":"queue_submission","click .post_control.delete":"delete","click .post_control.approve":"approve","click .post_control.post_control_menu.creator":"creator_popover","click .post_control.post_control_menu.admin":"admin_popover","click .tumblelog_menu_button":"user_popover","touchend .tumblelog_menu":"user_popover","click .post_control.deny":"deny","click .note .follow":"follow","click .photo_reply_image_container":"photo_reply_click"},initialize:function(){this.controls={};this.controls.like=this.$el.find(".post_control.like");this.controls.reblog=this.$el.find(".post_control.reblog");this.note_count=this.$el.find(".note_count");this.tagsDraggable();if(this.model.get("accepts_answers")){this.setupAnswerForm()}this.like_heart_timeout=null;this.is_click_trigger=false;this.is_reblogged=false;this.model.on("like:success",this.updateLikeStatus.bind(this,true));this.model.on("unlike:success",this.updateLikeStatus.bind(this,false));this.model.on("like:success",this.updateNoteCount.bind(this,true));this.model.on("unlike:success",this.updateNoteCount.bind(this,false));this.model.on("destroy:success",this.destroy.bind(this));this.model.on("dismiss",this.destroy.bind(this));this.model.on("publish:success",this.destroy.bind(this));this.model.on("queue:success",this.destroy.bind(this));this.model.on("unpromote:success",this.destroy.bind(this));this.model.on("promote:failure",this.alert.bind(this));this.model.on("deny:success",this.destroy.bind(this));this.model.on("approve:success",this.destroy.bind(this));this.model.on("answer:success",this.answer.bind(this));this.model.on("fastreblog:success",this.updateReblog.bind(this));this.model.on("remove_source:success",this.hidePost.bind(this));this.current_link=true;this.less_link=false;this.more_link=false},edit:function(){if(!q.PostForms){return}q.PostForms.edit({type:this.model.get("type"),edit:true,channel_id:this.model.get("tumblelog"),post_id:this.model.get("id"),endpoint:this.model.get("type"),attach_to:this.$el,previous_content_selector:this.$(".post_wrapper"),adjust_offset:true})},"delete":function(s){s.preventDefault();var r=g(s.currentTarget).data("confirm");q.Dialog.confirm(r,this.model.destroy.bind(this.model))},deny:function(s){s.preventDefault();var r=g(s.currentTarget).data("confirm");q.Dialog.confirm(r,function(){this.destroy();this.model.deny()}.bind(this))},approve:function(s){s.preventDefault();var r=g(s.currentTarget).data("confirm");q.Dialog.confirm(r,this.model.approve.bind(this.model,false))},queue:function(s){s.preventDefault();var r=g(s.currentTarget).data("confirm");q.Dialog.confirm(r,this.model.queue.bind(this.model))},queue_submission:function(s){s.preventDefault();var r=g(s.currentTarget).data("confirm");q.Dialog.confirm(r,this.model.approve.bind(this.model,true))},creator_popover:function(r){if(r.target!=r.currentTarget){return}var s=g(r.currentTarget);if(!(this.creatorPopover instanceof e)){this.creatorPopover=new e({model:this.model,el:g(r.target),on_hide:function(){s.removeClass("active")}.bind(this)});this.creatorPopover.on("action:edit",this.edit.bind(this))}s.addClass("active");this.creatorPopover.show()},admin_popover:function(r){if(r.target!=r.currentTarget){return}if(!(this.adminPopover instanceof b)){this.adminPopover=new b({model:this.model,el:g(r.target)})}this.adminPopover.show()},user_popover:function(s){var r=(s.type=="touchend");if(r){s.preventDefault();s.stopPropagation();this.$el.off("click",".tumblelog_menu_button")}if(!(this.userPopover instanceof h)){var t=this.$(s.currentTarget);this.userPopover=new h({model:this.model,el:r?t:t.closest(".tumblelog_menu"),popover:r?t.find(".popover"):t.siblings(".popover")})}this.userPopover.show()},like:function(r){r.preventDefault();this.is_click_trigger=true;this.model.like("mouse")},unlike:function(r){r.preventDefault();this.is_click_trigger=true;this.model.unlike()},reply:function(r){var s=g(r.currentTarget);if(!(this.replyPopover instanceof i)){this.replyPopover=new i({model:this.model,el:s});this.replyPopover.on("success",function(){s.addClass("replied")});this.replyPopover.on("close",function(){s.removeClass("active")})}s.addClass("active");this.replyPopover.show()},publish:function(s){s.preventDefault();var r=g(s.currentTarget).data("confirm");q.Dialog.confirm(r,this.model.publish.bind(this.model))},reblog:function(r){if(r.altKey&&!this.model.reblogged){r.preventDefault();this.is_click_trigger=true;return this.fastReblog(r)}if(this.is_reblogged||!q.PostForms){return}r.preventDefault();this.is_click_trigger=true;q.PostForms.edit({type:this.model.get("type"),channel_id:this.model.get("tumblelog"),reblog_id:this.model.get("id"),endpoint:this.model.get("type"),detached:true,reblog:true,animate_from:this.$el,reblog_key:this.model.get("reblog_key"),previous_content_selector:null})},fastReblog:function(r){r.stopPropagation();r.preventDefault();if(!this.is_reblogged){this.model.fastReblog()}},follow:function(t){t.preventDefault();var s=g(t.currentTarget);var r=s.closest(".note");var u=r.data("tumblelog");r.addClass("is_following");this.model.follow(u)},ignore:function(s){s.preventDefault();var r=g(s.target).data("block")||this.model.get("tumblelog");var t=q.TumblelogActions.confirm_ignore({tumblelog:r,avatar_url:this.$(".post_avatar_link").attr("data-avatar-url")});t.done(_.bind(this.model.ignore,this.model,r))},hidePost:function(r){this.$el.fadeOut("fast")},updateReblog:function(r){this.is_reblogged=true;var t=g('<div class="post_reblog_poof post_poof"></div>'),s=this.controls.reblog;if(r){t.addClass("queue")}if(this.is_click_trigger){s.append(t)}else{if(this.$el.height()>g(window).height()){t.css("top",g(window).height()*0.5)}this.$el.append(t)}this.is_click_trigger=false;setTimeout(function(){t.fadeOut(200,function(){t.remove();s.addClass("reblogged");if(r){s.addClass("queued")}})},300)},updateLikeStatus:function(s){this.controls.like.toggleClass("liked",s);var r=g('<div class="post_animated_heart post_poof"><span class="heart_left"></span><span class="heart_right"></span></div>').toggleClass("unliked",!s);if(this.is_click_trigger){this.controls.like.append(r)}else{if(this.$el.height()>g(window).height()){r.css("top",g(window).height()*0.5)}if(g(".post_animated_heart").length>0){var t=0.2+(Math.random()*0.6);r.css("left",this.$el.width()*t)}this.$el.append(r)}this.is_click_trigger=false;setTimeout(function(){r.fadeOut(200,function(){r.remove()})},300)},updateNoteCount:function(s){var r=this.$(".note_link_current"),t;if(s){t=r.data("more");if(r.data("more")!=r.text()){r.data("less",r.text())}this.$el.removeClass("no_notes")}else{t=r.data("less");if(!t.length){this.$el.addClass("no_notes")}}r.text(t);r.attr("title",t)},destroy:function(){this.$el.fadeOut(500,function(){this.unbind();this.$el.parent().remove();q.Events.trigger("DOMEventor:updateRect");this.remove()}.bind(this))},alert:function(r){alert(r)},tagsDraggable:function(){var r=this.$(".post_tags");var s=r.find(".post_tags_inner");if(r.width()<s.width()){r.addClass("draggable no_pop");new o({el:r})}},setupAnswerForm:function(){var r=this.$(".post_answer");if(!(this.answer_form instanceof n)&&r.find(".post_answer_input").length){this.answer_form=new n({model:this.model,el:r,existing_note:this.$el.hasClass("existing_note")})}},answer:function(){this.$el.addClass("existing_note")},photo_reply_click:function(r){q.Lightbox.init([{high_res:g(r.currentTarget).find("img").attr("src"),low_res:g(r.currentTarget).find("img").attr("src"),width:500}])}});var f=c.extend({events:{"click .post_control.like":"send_to_signup","click .post_control.reblog":"send_to_signup"},send_to_signup:function(r){if(r){g(r.currentTarget).trigger("PostsView:send_to_signup",[r,this]);if(r.isPropagationStopped()){return false}r.preventDefault();r.stopPropagation()}window.open("/register");return false}});var l=c.extend({events:{'click [data-action="ignore"]':"ignore",'click [data-action="read_more"]':"read_more",'click [data-action="deny"]':"deny",'click [data-action="reply"]':"reply"},read_more:function(r){r.preventDefault();this.$(".read_more").hide();this.$(".message_body_truncated").hide();this.$(".message_body").show()},reply:function(r){r.preventDefault();q.FanMail.show(r.target)},deny:function(r){c.prototype.deny.call(this,r)}});q.NotesPopover=q.PopoverWithScroll.extend({show_by_el:function(r){this.$el=g(r);this.$container=this.$el.find(".notes_container");this.$scroll=this.$el.find(".popover_scroll");this.popover=this.$el.find(".popover");this.show()}});q.Notes=Backbone.View.extend({el:"#posts",loading_notes:false,at_end:false,events:{"click .post_notes_label":"show_notes","click .more_notes_link":"on_more_click",keydown:"on_keydown"},initialize:function(){var r=this;this.popover=new q.NotesPopover({direction:"left",disable_auto_show:true,on_show:function(){r.on_notes_show(this.$el)},on_load_more:function(){if(!r.loading_notes&&this.$el.find("a.more_notes_link").length>0){r.more_notes(this.$el.closest(".post"))}}})},show_notes:function(r){r.preventDefault();if(this.popover.is_showing){return}this.popover.show_by_el(r.currentTarget);q.KeyCommands.suspend([74,75])},create_note_views:function(r){r.find(".note:not([data-view-exists])").each(function(t,v){if(g(v).hasClass("reblog")){var u=new q.ReblogNoteView({el:v})}else{var s=new q.NoteView({el:v})}g(v).attr("data-view-exists",true)});this.popover.update()},updateControls:function(s,t){var r=s.find(".more_notes_link");if(t){s.show();r.attr("data-next",t).show()}else{this.at_end=true;this.popover.is_scroll_disabled=true;r.attr("data-notes-complete",true);s.hide()}},animate_in:function(r){this.loading_notes=true;r.slideDown(300,_.bind(function(){this.loading_notes=false},this))},on_more_click:function(r){r.preventDefault();this.more_notes(g(r.currentTarget).closest(".post"))},on_keydown:function(s){var r=s.charCode?s.charCode:s.keyCode;if(r===78&&this.popover.is_showing){s.preventDefault();s.stopPropagation();this.popover.hide()}},on_notes_show:function(t){var s=g(t),r=s.closest(".post");this.at_end=(s.find(".more_notes_link").data("notes-complete"))?true:false;this.popover.is_scroll_disabled=this.at_end;if(!s.attr("data-notes-loaded")){this.load_notes(r,{},_.bind(function(v,w,u){if(!v){this.popover.hide()}s.attr("data-notes-loaded",true)},this))}},more_notes:function(r){$post=g(r);$link=$post.find(".more_notes_link").hide();$loading=$post.find(".notes_loading").show();this.loading_notes=true;this.load_notes($post,{from_id:$link.attr("data-next")},_.bind(function(t,u,s){$loading.hide();$link.show();this.loading_notes=false},this))},load_notes:function(r,t,u){var s="/dashboard/notes/"+r.attr("data-post-id")+"/"+r.attr("data-tumblelog-key")+"/"+r.attr("data-tumblelog-name");if(t.from_id){s+="?from_c="+t.from_id}g.ajax(s).done(_.bind(function(A,B,y){var x=r.find(".more_notes_link_container"),v=r.find(".notes"),w=r.find(".more_notes_link"),z=r.find(".notes_loading");w.show();z.hide();A=g.trim(A);this.updateControls(x,y.getResponseHeader("X-next-note"));v.append(g(A).children());this.create_note_views(v);q.Events.trigger("DOMEventor:updateRect");u(A,B,y)},this))}});var o=Backbone.View.extend({initialize:function(){this.dragging=false;this.drag_x=false;this.drag_inner=this.$(".post_tags_inner");this.doc=g(document);this.d=this.getDimensions();this.transform=this.isTransformSupported();this.bindEvents()},bindEvents:function(){this.$el.on("mousedown touchstart touchmove mouseleave mouseup touchend",".post_tags_inner",_.bind(this.dragEvents,this));this.$el.on("click",".post_tag",_.bind(this.handleLinks,this))},getDimensions:function(){var s=this.$el.width();var r=this.drag_inner.width();return{post_width:s,tag_width:r,max_left:0,max_right:((s-r)-10)}},isTransformSupported:function(){var s="transform WebkitTransform MozTransform OTransform msTransform".split(" ");for(var r=0;r<s.length;r++){if(document.createElement("div").style[s[r]]!==undefined){return true}}return false},dragEvents:function(r){switch(r.type){case"mousedown":case"touchstart":this.dragStart(r);break;case"mousemove":case"touchmove":if(this.pointer_down){this.dragMove(r)}break;case"touchend":case"mouseup":this.dragEnd(r);break}},bindDocEvents:function(){this.doc.on("mousemove.tagsDraggable",_.bind(this.dragEvents,this));this.doc.on("mouseup.tagsDraggable",_.bind(this.resetDrag,this))},unbindDocEvents:function(){this.doc.off("mousemove.tagsDraggable");this.doc.off("mouseup.tagsDraggable")},dragStart:function(r){r.preventDefault();if(!this.dragging&&!this.pointer_down){this.pointer_down=true;this.start_x=this.drag_inner.position().left;this.page_x=("pageX" in r?r.pageX:r.originalEvent.touches[0].pageX);this.bindDocEvents()}},dragMove:function(s){s.preventDefault();s.stopPropagation();this.drag_inner[0].classList.add("dragging");this.dragging=true;var r=("clientX" in s?s.clientX:s.originalEvent.touches[0].clientX)-this.page_x;this.drag_x=r+this.start_x;this.dragSet(this.drag_x)},dragSet:function(r){if(this.transform){this.drag_inner.css("transform","translate("+r+"px, 0)")}else{this.drag_inner.css("left",r)}},handleLinks:function(r){r.preventDefault();r.stopPropagation();if(!this.dragging){window.open(g(r.currentTarget).attr("href"),"_blank")}return false},resetDragPosition:function(){if(this.drag_x>this.d.max_left){this.dragSet(this.d.max_left)}else{if(this.drag_x<this.d.max_right){this.dragSet(this.d.max_right)}}},dragEnd:function(s){s.preventDefault();s.stopPropagation();var r=_.bind(this.resetDrag,this);_.delay(r,100)},resetDrag:function(){if(this.dragging||this.pointer_down){this.dragging=false;this.pointer_down=false;this.drag_inner[0].classList.remove("dragging");this.resetDragPosition();this.unbindDocEvents()}}});var n=Backbone.View.extend({events:{"keyup .post_answer_input":"keyup","focus .post_answer_input":"focus","blur  .post_answer_input":"blur","click .post_answer_submit":"submit"},initialize:function(r){this.options=r||{};this.max_length=140;this.answer_input=this.$(".post_answer_input");this.answer_submit=this.$(".post_answer_submit");this.answer_length=this.$(".post_answer_length");this.answer_error_message=this.answer_input.data("error-message");this.existing_note=this.options.existing_note||false;this.answer_text=this.answer_input.val();this.model.on("answer:success",this.answer.bind(this));this.model.on("answer:failure",this.error.bind(this))},keyup:function(r){if(this.existing_note){return false}this.remaining_chars=this.max_length-this.getAnswerLength();if(this.remaining_chars<=0){this.remaining_chars=0}this.answer_length.text(this.remaining_chars);this.answer_text=(this.answer_text!==this.answer_input.val())?this.answer_input.val():this.answer_text;if(r.keyCode==13){r.preventDefault();this.answer_post()}},focus:function(r){if(this.existing_note){return false}this.answer_text=this.answer_input.val();this.$el.addClass("show_submit")},blur:function(r){if(this.getAnswerLength()==0){this.$el.removeClass("show_submit")}},submit:function(r){r.preventDefault();this.answer_post()},answer_post:function(){if(this.getAnswerLength()){this.model.answer(this.getAnswer())}},answer:function(){this.answer_input.blur();this.answer_input.attr("readonly","readonly")},error:function(){q.Dialog.confirm(this.answer_error_message)},getAnswerLength:function(){return this.getAnswer().length},getAnswer:function(){return g.trim(this.answer_input.val())}});q.Post=d;q.PostView=c;q.Posts=new m();q.PostsView=k;g(function(r){new q.PostsView();if(q&&q.Capture){q.CaptureWebInStream=new q.Capture.WebInStream()}})})(jQuery,Tumblr);