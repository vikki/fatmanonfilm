(function(c,a){var b=Backbone.View.extend({defaults:{left_offset:-36,top_offset:13},default_templates:{popover:'<div id="mention_popover_<%= uid %>" class="popover popover_menu popover_gradient mention_popover nipple_on_<%- nipple_position %>" style="display:none;"><div class="popover_inner"><%= items %></div></div>',items:'<% _.each(items, function(item, i) { %><div id="mention_<%- i %>" class="popover_menu_item" data-tumblelog="<%- items[i].name %>"><div class="t_info"><span class="t_name"><%= items[i].hilite_name %></span><span class="t_title"><%- items[i].title %></span></div><span class="result_thumb thumb" style="background-image:url(\'<%- items[i].avatar_url %>\')"></span></div><% }); %>'},events:{"mouseenter .popover_menu_item":"_hover","mouseleave .popover_menu_item":"_hover","click .popover_menu_item":"_click"},initialize:function(d){this.options=d||{};this.options=_.extend(this.defaults,this.options);if(!_.isObject(this.options.list)||_.isUndefined(this.options.list.blogs)){return false}this.templates=this.default_templates;this.uid=Math.floor(Math.random()*100001);this.position=this.options.position;this.list=this.options.list.blogs;this.is_active=false;this.$popover=false;this.$items=false;this.$container=c(this.options.container);this.show()},_html_items:function(d){var f={items:d};var e=_.template(this.templates.items);return e(f)},_html_popover:function(d){var f={uid:this.uid,nipple_position:"top",items:d};var e=_.template(this.templates.popover);return e(f)},show:function(){c(".popover.mention_popover").remove();if(!_.isObject(this.list)||this.list.length===0){c("#mention_popover_"+this.uid).hide();this.is_active=false;return false}var e=this._items_underline(this.list,this.options.mention);var d=this._html_items(e);var f=this._html_popover(d);this.$container.append(f);this.$popover=c("#mention_popover_"+this.uid);this.popover=new Tumblr.Popover({el:this.$popover,popover:this.$popover,button:this.$container,skip_glass:true,skip_offset:true,left:(this.position.left+this.options.left_offset),top:(this.position.top+this.position.height+this.options.top_offset),disable_auto_show:true,on_show:_.bind(function(){},this),on_hide:_.bind(function(){},this)});this.$items=jQuery(".popover_menu_item",this.$popover);this.$el=this.$popover;this.popover.show();this.is_active=true},hide:function(){this.is_active=false;this.$items=false;if(this.popover&&this.popover.is_showing){this.popover.hide()}},update:function(g,e,d){if(!this.is_active){return false}if(!_.isUndefined(d)){this.position=d}this._update_position();this.list=this._items_underline(e.blogs,g);var f=this._html_items(this.list);c(".popover_inner",this.$popover).html(f);this.$items=jQuery(".popover_menu_item",this.$popover);this._remove_helpers();if(!_.isObject(this.list)||this.list.length===0){this.$popover.hide()}else{this.$popover.show()}},update_position:function(d){if(!_.isObject(d)||!_.isObject(this.position)){return}if((this.position.left===d.left)&&(this.position.top===d.top)){return}this.position=d;this._update_position()},_update_position:function(){if(this.$popover.length>0){this.$popover.css({left:(this.position.left+this.options.left_offset),top:(this.position.top+this.position.height+this.options.top_offset)})}},up:function(){if(!this.is_active||!this.$popover){return false}if(!this.$items||this.$items.length===0){return false}this._remove_helpers();var d=this.$items.filter(".focus");var e=this.$items.index(d);if(e===-1){$next=this.$items.filter(":last")}else{$next=this.$items.filter(":eq("+(e-1)+")")}d.removeClass("focus");this._update_current($next);return true},down:function(){if(!this.is_active||!this.$popover){return false}if(!this.$items||this.$items.length===0){return false}this._remove_helpers();var d=this.$items.filter(".focus");var e=this.$items.index(d);if(e===-1||e>=(this.$items.length-1)){$next=this.$items.filter(":first")}else{$next=this.$items.filter(":eq("+(e+1)+")")}d.removeClass("focus");this._update_current($next);return true},enter:function(e,d){if(!this.is_active||!this.$popover){return false}if(!this.$items||this.$items.length===0){return false}var h=false;var g=this.$items.filter(".focus");if(!h&&g.length===1){h=g.data("tumblelog")}var f=this.$items.first();if(!h&&f.length===1){h=f.data("tumblelog")}if(h){if(!_.isUndefined(e)){if(h.toUpperCase()!==e.toUpperCase()){return false}}Tumblr.Mention.tinymce.set_suggestion(h,(!_.isUndefined(d)&&d===true));return true}return false},_hover:function(d){if(this.$items&&this.$items.length>0){this.$items.removeClass("focus")}this._remove_helpers();$next=jQuery(d.currentTarget);this._update_current($next)},_click:function(d){$current=jQuery(d.currentTarget).closest(".popover_menu_item");Tumblr.Mention.tinymce.set_suggestion($current.data("tumblelog"));return false},_update_current:function(d){if(!d||d.length===0){return}d.addClass("focus");this._remove_helpers();if(d.is(":first-child")){this.$el.addClass("first-item")}else{if(d.is(":last-child")){this.$el.addClass("last-item")}else{this.$el.addClass("inner-item")}}var e=d.data("tumblelog");if(!_.isUndefined(e)){Tumblr.Mention.tinymce.update_typeahead(e)}},_remove_helpers:function(){this.$el.removeClass("inner-item first-item last-item")},is_selected:function(){if(!this.is_active||!this.$items||this.$items.length===0){return false}$selected=this.$items.filter(".focus");return($selected.length===1)},destroy:function(){this.hide();if(this.$popover){this.$popover.remove()}},_items_underline:function(d,e){var f=new RegExp(this._escapeRegExp(e),"gi"),g=this.decorate_item_substring;if(!f){return false}_.each(d,function(j,h){d[h].hilite_name=j.name.replace(f,g)});return d},decorate_item_substring:function(d){return"<u>"+d+"</u>"},_escapeRegExp:function(d){return d.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|\~\`\!\@\#]/g,"\\$&")}});a.MentionPopover=b})(jQuery,Tumblr);(function(c,b){var a=Backbone.Model.extend({defaults:{route:"/svc/mention"},initialize:function(d){this.options=_.extend(this.defaults,this.options);this.form_key=c("#tumblr_form_key").attr("content");this.user_cache={};this.tinymce=false;this.container=false;this.popover=false;this.last_search=false;this.is_waiting=false;this.is_active=false;this.req=false},setup:function(d){if(d){this.tinymce=d}},search:function(d,f){if(!_.isFunction(f)){var f=function(){}}if(!_.isUndefined(this.user_cache[d])){if((!this.tinymce.is_mention_active())||(this.tinymce.mention_string(true)!==d.toUpperCase())){return}f.call(this.user_cache[d],d,this);this.show(this.container,this.position,this.user_cache[d],d);return}if((typeof this.req==="object")&&this.req!==false){this.req.abort()}this.is_waiting=true;var e=c.ajax({url:this.options.route,type:"GET",data:{q:d,form_key:this.form_key}});e.done(_.bind(function(g){this.user_cache[d]=g;if((!this.tinymce.is_mention_active())||(this.tinymce.mention_string(true)!==d.toUpperCase())){return}f.call(this.user_cache[d],d,this);this.show(this.container,this.position,this.user_cache[d],d);this._reset()},this));e.fail(_.bind(function(){this.user_cache[d]={};this._reset();if(!Tumblr.Dialog.is_visible){Tumblr.Dialog.alert(l10n_str.ajax_error)}},this))},_reset:function(){if((typeof this.req==="object")&&this.req!==false){this.req.abort()}this.is_waiting=false},update:function(e,f,d,g){if(f.string===this.last_search){return}this.last_search=f.string;this.container=e;this.mention=f;this.position=d;this.search(f.string);if(_.isFunction(g)){g()}},show:function(e,d,g,f){if(!this.tinymce.is_mention_active()){return}if(this.popover&&this.popover.is_active){this.popover.update(f,g,d)}else{this.is_active=true;this.popover=new Tumblr.MentionPopover({container:e,position:d,mention:f,list:g});if(typeof _gaq!=="undefined"&&_gaq){_gaq.push(["_trackEvent","mentions","popover","opened"])}}var h="";if(_.isObject(g.blogs)&&!_.isEmpty(g.blogs)){h=g.blogs[0].name}if((!this.tinymce.is_mention_active())||(this.tinymce.mention_string(true)!==f.toUpperCase())){return}this.tinymce.update_typeahead(h)},update_position:function(d){if(!_.isObject(d)||!this.popover&&!this.popover.is_active){return}this.popover.update_position(d)},hide:function(d){if(!_.isUndefined(d)&&(d===true)){if(this.is_active){this.tinymce.abort_current(false)}}this._reset();this.is_active=false;this.last_search=false;if(_.isObject(this.popover)){this.popover.destroy()}}});b.Mention=new a()})(jQuery,Tumblr);